(function(){function c(f){this.slider=f;this.slides=[];this.panos=f.find("li[data-panorama]").each(function(g){0===g&&this.setAttribute("data-fstransition","notransition");this.setAttribute("data-transition","fade")});f.one("revolution.slide.onloaded",this.onLoaded.bind(this)).one("rsPanoramaDestroyed",this.destroy.bind(this))}function b(g,f,l,k){var h=JSON.parse(g.attr("data-panorama"));this.y=this.x=0;this.zoomVal=1;this.width=l;this.height=k;this.slide=g;this.slider=f;this.distY=this.distX=!1;this.image=h.image;this.controls=h.controls;this.drag="drag"===this.controls;this.thrw="throw"===this.controls;this.move=this.drag||this.thrw;this.mouse="mouse"===this.controls;this.click="click"===this.controls;this.autoplay="true"==h.autoplay;this.zoom="true"==h.mousewheelZoom;this.smoothZoom="true"==h.smoothZoom;f="forward"===h.autoplayDirection?1:-1;this.autoplaySpeed=0.001*parseInt(h.autoplaySpeed,10);this.speed=this.autoplaySpeed*f;this.throwSpeed=0.001*parseInt(h.throwSpeed,10);this.zoomMax=2-0.01*parseInt(h.zoomMax,10);this.zoomMin=2-0.01*parseInt(h.zoomMin,10);this.fov=parseInt(h.cameraFov,10);this.onStart=this.start.bind(this);this.onZoom=this.zooming.bind(this);this.inZoom=this.zoomIn.bind(this);this.outZoom=this.zoomOut.bind(this);this.onRender=this.render.bind(this);this.onMouse=this.mouseEvent.bind(this);this.onImgChange=this.imgChange.bind(this);this.fireAction=this.onAction.bind(this);this.renderer=new THREE[e];this.renderer.setSize(l,k);this.camera=new THREE.PerspectiveCamera(this.fov,l/k,1,parseInt(h.cameraFar,10));this.camera.target=new THREE.Vector3(0,0,0);l=new THREE.SphereGeometry(parseInt(h.sphereRadius,10),parseInt(h.sphereWsegments,10),parseInt(h.sphereHsegments,10));this.texture=new THREE.TextureLoader;this.texture.minFilter=THREE.LinearFilter;l.applyMatrix((new THREE.Matrix4).makeScale(-1,1,1));this.material=new THREE.MeshBasicMaterial;this.scene=new THREE.Scene;this.scene.add(new THREE.Mesh(l,this.material));i.data(g[0],"rsaddonpanorama",this);this.canvas=i(this.renderer.domElement).addClass("rsaddon-panorama").appendTo(g.find(".slotholder"));g.on("mouseleave",this.onLeave.bind(this)).find(".tp-withaction").each(a)}function o(f){f.stopPropagation()}function a(){var g=jQuery(this),f=g.data().actions;if(!g.hasClass("rspanoaction")&&Array.isArray(f)){for(var k=f.length,h;k--;){if(h=f[k],-1!==h.action.search("panorama")){g.addClass("rspanoaction").on("mousedown click mousemove touchmove",o)}}}}function j(){try{var g=document.createElement("canvas");(g=!(!window.WebGLRenderingContext||!g.getContext("webgl")&&!g.getContext("experimental-webgl")))&&(g="WebGLRenderer")}catch(f){}g||(g=window.CanvasRenderingContext2D)&&(g="CanvasRenderer");return g}var i,e,d=window.requestAnimationFrame;window.RsAddonPanorama=function(g,f){if(!e&&(e=j(),!e)){f.addClass("pano-no-webgl");return}if(g&&f&&"undefined"!==typeof THREE&&d&&f.find("li[data-panorama]").length){return i=g,i.event.special.rsPanoramaDestroyed={remove:function(h){h.handler()}},new c(f)}};c.prototype={onLoaded:function(){this.slider.one("revolution.slide.onchange",this.onReady.bind(this));jQuery(window).on("blur.rsaddonpanorama",this.onBlur.bind(this))},onReady:function(g,f){this.resize();var k=this;this.panos.each(function(l){k.slides[l]=new b(i(this),k.slider,k.width,k.height)});this.slider.on("revolution.slide.afterdraw",this.resize.bind(this)).on("revolution.slide.onbeforeswap",this.beforeSwap.bind(this)).on("revolution.slide.onafterswap",this.afterSwap.bind(this)).on("layeraction",this.layerAction.bind(this));var h=i.data(f.currentslide[0],"rsaddonpanorama");if(h){h.onReset()}this.panos=null},beforeSwap:function(g,f){var h=i.data(f.currentslide[0],"rsaddonpanorama");h&&h.controls&&h.removeEvents();if(h=i.data(f.nextslide[0],"rsaddonpanorama")){h.onReset()}},afterSwap:function(g,f){this.currentSlide=i.data(f.currentslide[0],"rsaddonpanorama");if(f.prevslide.length){var h=i.data(f.prevslide[0],"rsaddonpanorama");h&&(h.paused=!0)}},resize:function(){this.width=this.slider.width();this.height=this.slider.height();for(var g=this.slides.length,f;g--;){f=this.slides[g],f.resize(this.width,this.height)}},onBlur:function(){for(var g=this.slides.length,f;g--;){f=this.slides[g],f.clear(),f.canvas.trigger("mouseup").trigger("mouseleave").trigger("touchend")}},layerAction:function(g,f){f=f.event;var k=f.action;if(k&&-1!==k.search("panorama")&&this.currentSlide){var h=f.hasOwnProperty("percentage")?0.01*f.percentage:!1;this.currentSlide.action(k.replace("panorama_",""),h)}},destroy:function(){if(this.slides){for(;this.slides.length;){this.slides[0].destroy(),this.slides.shift()}}for(var f in this){this.hasOwnProperty(f)&&delete this[f]}}};b.prototype={start:function(){this.imgLoaded||(this.imgLoaded=!0);this.currentSlide&&(this.newImage&&(this.y=this.x=0,this.zoomVal=1,this.camera.fov=this.fov,this.camera.updateProjectionMatrix(),this.newImage=!1),this.paused=this.controller=!1,d(this.onRender),this.addEvents(),this.running=!0,this.slider.addClass("rsaddon-pano"))},render:function(){if(!this.paused&&this.camera){this.y=Math.max(-85,Math.min(85,this.y));if(!1!==this.distX||!1!==this.distY){!1!==this.distX?(this.x+=0.05*(this.distX-this.x),1>Math.abs(this.distX-this.x)&&(this.distX=!1,clearInterval(this.actionTimer))):!1!==this.distY&&(this.y+=0.05*(this.distY-this.y),1>Math.abs(this.distY-this.y)&&(this.distY=!1,clearInterval(this.actionTimer)))}else{if(this.controller){if(this.move){this.thrw&&(this.mousedown?(this.vx=this.x-this.oldX,this.vy=this.y-this.oldY,this.oldX=this.x,this.oldY=this.y):(g=Math.abs(this.vx),f=Math.abs(this.vy),0.01<g&&(this.x+=this.vx),0.01<f&&(this.y+=this.vy),this.vx*=this.throwSpeed,this.vy*=this.throwSpeed,0.01>=g&&0.01>=f&&(this.controller=!1)))}else{var g=(this.mouseX-this.left)/this.width,f=(this.mouseY-this.top)/this.height,g=0.5>=g?-180*(1-2*g):360*(g-0.5),f=Math.max(-85,Math.min(85,0.5>=f?85*(1-2*f):-170*(f-0.5)));this.x+=0.05*(g-this.x);this.y+=0.05*(f-this.y);(this.click||this.mouse)&&1>Math.abs(g-this.x)&&1>Math.abs(f-this.y)&&(this.controller=!1)}}else{this.autoplay&&(this.x+=this.speed)}}g=THREE.Math.degToRad(this.x);f=THREE.Math.degToRad(90-this.y);this.camera.target.x=Math.sin(f)*Math.cos(g);this.camera.target.z=Math.sin(f)*Math.sin(g);this.camera.target.y=Math.cos(f);this.camera.lookAt(this.camera.target);this.smoothZoom&&(this.camera.fov+=0.05*(this.fov*this.zoomVal-this.camera.fov),this.camera.updateProjectionMatrix());this.renderer.render(this.scene,this.camera);d(this.onRender)}},onLeave:function(){clearInterval(this.actionTimer);clearInterval(this.zoomTimer)},clear:function(){clearInterval(this.actionTimer);clearInterval(this.zoomTimer);this.distY=this.distX=!1},onAction:function(){this.action(this.actionType,this.actionPerc)},action:function(g,f){switch(g){case"left":this.distX=this.x+-180*f;break;case"right":this.distX=this.x+180*f;break;case"up":var k=this.y+85*f;this.distY=Math.max(-85,Math.min(85,k));break;case"down":k=this.y+-85*f;this.distY=Math.max(-85,Math.min(85,k));break;case"leftstart":var h="left";break;case"rightstart":h="right";break;case"upstart":h="up";break;case"downstart":h="down";break;case"leftend":case"rightend":case"upend":case"downend":clearInterval(this.actionTimer);break;case"zoomin":clearInterval(this.zoomTimer);this.zooming("gestureend",0.5);break;case"zoomout":clearInterval(this.zoomTimer);this.zooming("gestureend",1.5);break;case"zoominstart":clearInterval(this.zoomTimer);this.inZoom();this.zoomTimer=setInterval(this.inZoom,100);break;case"zoomoutstart":clearInterval(this.zoomTimer);this.outZoom();this.zoomTimer=setInterval(this.outZoom,100);break;case"zoominend":case"zoomoutend":clearInterval(this.zoomTimer)}h&&(this.clear(),this.actionPerc=f,this.actionType=h,this.fireAction(),this.actionTimer=setInterval(this.fireAction,100))},zooming:function(g,f){this.prevZoom=this.zoomVal;if("gestureend"!==g){var h=g.type;f=g.scale}else{h=g}this.zoomVal="gestureend"!==h?0<g.originalEvent.wheelDelta||0>g.originalEvent.detail?this.zoomVal-0.05:this.zoomVal+0.05:1>f?this.zoomVal-0.05:this.zoomVal+0.05;this.zoomVal=Math.max(this.zoomMax,Math.min(this.zoomMin,this.zoomVal));this.zoomVal!==this.zoomMax&&this.zoomVal!==this.zoomMin||clearInterval(this.zoomTimer);this.smoothZoom||(this.camera.fov=this.fov*this.zoomVal,this.camera.updateProjectionMatrix());return !1},zoomIn:function(){this.zooming("gestureend",0.5)},zoomOut:function(){this.zooming("gestureend",1.5)},imgChange:function(){this.timer=setTimeout(this.onStart,500)},update:function(g,f,h){clearTimeout(this.timer);this.removeEvents();this.paused=!0;switch(g){case"image":this.newImage=!0;this.material.map=this.texture.load(f,this.onImgChange);break;case"controls":this.controls=f;"none"!==f?(this.drag="drag"===f,this.thrw="throw"===f,this.mouse="mouse"===f,this.click="click"===f,this.move=this.drag||this.thrw):this.y=this.x=0;break;case"autoplay":this.autoplay="true"==f;break;case"direction":this.speed=this.autoplaySpeed*("forward"===f?1:-1);break;case"zoom":"false"==f?(delete this.zoom,this.zoomVal=1,this.camera.fov=this.fov,this.camera.updateProjectionMatrix()):this.zoom=!0;break;case"smooth":this.smoothZoom="true"==f}"image"!==g&&(this.timer=setTimeout(this.onStart,500))},resize:function(g,f){this.width=g;this.height=f;this.renderer.setSize(g,f);this.camera.aspect=g/f;this.camera.updateProjectionMatrix()},onReset:function(){this.currentSlide=this.paused=!0;this.y=this.x=0;this.distY=this.distX=!1;this.zoomVal=1;this.camera.fov=this.fov;this.camera.updateProjectionMatrix();this.imgLoaded?this.start():this.material.map=this.texture.load(this.image,this.onStart)},enterMouse:function(g,f){this.move&&this.canvas.removeClass("rsaddon-panorama-drag").addClass("rsaddon-panorama-dragging");this.clear();this.mousedown=this.controller=!0;var h=this.slider.offset();this.left=h.left;this.top=h.top;f||((h=g.originalEvent.touches)&&(g=h[0]),this.startX=g.pageX-this.left,this.startY=g.pageY-this.top,this.prevX=this.x,this.prevY=this.y,this.oldX=this.x,this.oldY=this.y,this.canvas.on("mousemove.rsaddonpanorama touchmove.rsaddonpanorama",this.onMouse))},mouseEvent:function(g){this.onLeave();if(-1!==g.type.search(/move|click/)){if(this.move){if(!this.controller||!this.mousedown){return}}else{this.controller||this.enterMouse(g,!0)}var f=g.originalEvent.touches;f&&(g=f[0]);this.move?(this.x=this.prevX+0.1*(this.startX-(g.pageX-this.left)),this.y=this.prevY+0.1*(g.pageY-this.top-this.startY)):(this.mouseX=g.pageX,this.mouseY=g.pageY)}else{-1!==g.type.search(/down|enter|start/)?this.enterMouse(g):(this.canvas.off("mousemove.rsaddonpanorama touchmove.rsaddonpanorama"),this.drag&&(this.controller=!1),this.mousedown=!1,this.move&&this.canvas.removeClass("rsaddon-panorama-dragging").addClass("rsaddon-panorama-drag"))}},addEvents:function(){switch(this.controls){case"drag":case"throw":this.canvas.on("mousedown.rsaddonpanorama mouseup.rsaddonpanorama mouseleave.rsaddonpanorama touchstart.rsaddonpanorama touchend.rsaddonpanorama touchcancel.rsaddonpanorama",this.onMouse);break;case"click":this.slide.on("click.rsaddonpanorama",this.onMouse);break;case"mouse":this.slide.on("mousemove.rsaddonpanorama touchmove.rsaddonpanorama",this.onMouse)}if(this.zoom){this.slider.on("mousewheel.rsaddonpanorama DOMMouseScroll.rsaddonpanorama gestureend.rsaddonpanorama",this.onZoom)}"none"!==this.controls&&(this.move?this.canvas.addClass("rsaddon-panorama-drag"):this.click&&this.slide.addClass("rsaddon-panorama-click"))},removeEvents:function(){this.clear();this.currentSlide=this.controller=this.mousedown=!1;switch(this.controls){case"drag":case"throw":this.canvas.off(".rsaddonpanorama");break;case"mouse":case"click":this.slide.off(".rsaddonpanorama")}this.slider.off(".rsaddonpanorama");this.slide.removeClass("rsaddon-panorama-click");this.canvas.removeClass("rsaddon-panorama-drag rsaddon-panorama-dragging")},destroy:function(){for(var f in this){this.hasOwnProperty(f)&&delete this[f]}}}})();