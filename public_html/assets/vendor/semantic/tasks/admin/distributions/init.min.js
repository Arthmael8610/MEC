var gulp=require("gulp"),console=require("better-console"),del=require("del"),fs=require("fs"),path=require("path"),git=require("gulp-git"),githubAPI=require("github"),mkdirp=require("mkdirp"),github=require("../../config/admin/github.js"),release=require("../../config/admin/release"),project=require("../../config/project/release"),oAuth=fs.existsSync(__dirname+"/../../config/admin/oauth.js")?require("../../config/admin/oauth"):false,version=project.version;module.exports=function(f){var b=-1,c=release.distributions.length,e,d,a;if(!oAuth){console.error("Must add oauth token for GitHub in tasks/config/admin/oauth.js");return}a=function(){b=b+1;if(b>=c){f();return}var r=release.distributions[b],p=r.toLowerCase(),j=path.resolve(release.outputRoot+p),k=release.distRepoRoot+r,o={cwd:j},q={args:"-q",cwd:j,quiet:true},i={args:"-q --hard",cwd:j,quiet:true},u="git@github.com:"+release.org+"/"+k+".git",s="https://github.com/"+release.org+"/"+k+"/",w=fs.existsSync(path.join(j,".git"));console.log("Processing repository: "+j);if(!fs.existsSync(j)){mkdirp.sync(j)}if(release.outputRoot.search("../repos")==0){console.info("Cleaning dir",j);del.sync([j+"**/*"],{silent:true,force:true})}function m(){if(w){l()}else{t()}}function t(){console.info("Initializing repository for "+r);git.init(o,function(x){if(x){console.error("Error initializing repo",x)}l()})}function g(){console.info("Creating GitHub repo "+s);github.repos.createFromOrg({org:release.org,name:k,homepage:release.homepage},function(){m()})}function l(){console.info("Adding remote origin as "+u);git.addRemote("origin",u,o,function(){v()})}function v(){console.info("Pulling "+r+" files");git.pull("origin","master",q,function(x){h()})}function h(){console.info("Resetting files to head");git.reset("HEAD",i,function(x){n()})}function n(){global.clearTimeout(e);e=global.setTimeout(function(){a()},0)}if(w){v()}else{m()}};a()};