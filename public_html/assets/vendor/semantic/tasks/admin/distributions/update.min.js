var gulp=require("gulp"),console=require("better-console"),fs=require("fs"),path=require("path"),git=require("gulp-git"),githubAPI=require("github"),requireDotFile=require("require-dot-file"),github=require("../../config/admin/github.js"),release=require("../../config/admin/release"),project=require("../../config/project/release"),oAuth=fs.existsSync(__dirname+"/../../config/admin/oauth.js")?require("../../config/admin/oauth"):false,version=project.version;module.exports=function(f){var b=-1,c=release.distributions.length,e,d,a;if(!oAuth){console.error("Must add oauth token for GitHub in tasks/config/admin/oauth.js");return}a=function(){b=b+1;if(b>=c){f();return}var l=release.distributions[b],A=path.resolve(path.join(release.outputRoot,l.toLowerCase())),y=release.distRepoRoot+l,p=(oAuth.name!==undefined&&oAuth.email!==undefined)?'--author "'+oAuth.name+" <"+oAuth.email+'>"':"",h=fs.existsSync(A+"package.json")?require(A+"package.json"):false,u=(version&&h.version!=version),s=(u)?"Updated distribution to version "+version:"Updated files from main repo",w={cwd:A},k={args:p,cwd:A},x={tag_name:version,owner:release.org,repo:y},B={args:"config core.fileMode false",cwd:A},z={args:'config user.name "'+oAuth.name+'"',cwd:A},i={args:'config user.email "'+oAuth.email+'"',cwd:A},t={args:"rev-parse --verify HEAD",cwd:A},o=fs.existsSync(path.join(A,".git")),v=true;console.info("Processing repository:"+A);function r(){git.exec(B,function(){git.exec(z,function(){git.exec(i,function(){m()})})})}function m(){console.info("Committing "+l+" files",p);gulp.src("./",w).pipe(git.add(w)).pipe(git.commit(s,k)).on("error",function(C){}).on("finish",function(C){if(v){q()}else{console.info("Nothing new to commit");g()}})}function q(){console.info("Pushing files for "+l);git.push("origin","master",{args:"",cwd:A},function(C){console.info("Push completed successfully");j()})}function j(){git.exec(t,function(D,C){C=C.trim();n(C)})}function n(C){if(C){x.target_commitish=C}github.repos.createRelease(x,function(){g()})}function g(){console.log("Sleeping for 1 second...");global.clearTimeout(e);e=global.setTimeout(a,500)}if(o){r()}else{console.error("Repository must be setup before running update distributions")}};a()};