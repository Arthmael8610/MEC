var gulp=require("gulp"),console=require("better-console"),fs=require("fs"),path=require("path"),git=require("gulp-git"),githubAPI=require("github"),requireDotFile=require("require-dot-file"),github=require("../../config/admin/github.js"),release=require("../../config/admin/release"),project=require("../../config/project/release"),oAuth=fs.existsSync(__dirname+"/../../config/admin/oauth.js")?require("../../config/admin/oauth"):false,version=project.version;module.exports=function(f){var b=-1,c=release.components.length,e,d,a;if(!oAuth){console.error("Must add oauth token for GitHub in tasks/config/admin/oauth.js");return}a=function(){b=b+1;if(b>=c){f();return}var o=release.components[b],C=path.resolve(path.join(release.outputRoot,o)),p=o.charAt(0).toUpperCase()+o.slice(1),A=release.componentRepoRoot+p,D="https://github.com/"+release.org+"/"+A+".git",m="https://github.com/"+release.org+"/"+A+"/",q=(oAuth.name!==undefined&&oAuth.email!==undefined)?'--author "'+oAuth.name+" <"+oAuth.email+'>"':"",z=fs.existsSync(C+"package.json")?require(C+"package.json"):false,w=(version&&z.version!=version),t=(w)?"Updated component to version "+version:"Updated files from main repo",x={cwd:C},j={args:q,cwd:C},y={tag_name:version,owner:release.org,repo:A},E={args:"config core.fileMode false",cwd:C},B={args:'config user.name "'+oAuth.name+'"',cwd:C},h={args:'config user.email "'+oAuth.email+'"',cwd:C},u={args:"rev-parse --verify HEAD",cwd:C},n=fs.existsSync(path.join(C,".git")),v=true;console.info("Processing repository:"+C);function s(){git.exec(E,function(){git.exec(B,function(){git.exec(h,function(){k()})})})}function k(){console.info("Committing "+o+" files",q);gulp.src("./",x).pipe(git.add(x)).pipe(git.commit(t,j)).on("error",function(F){}).on("finish",function(F){if(v){r()}else{console.info("Nothing new to commit");g()}})}function r(){console.info("Pushing files for "+o);git.push("origin","master",{args:"",cwd:C},function(F){console.info("Push completed successfully");i()})}function i(){git.exec(u,function(G,F){F=F.trim();l(F)})}function l(F){if(F){y.target_commitish=F}github.repos.createRelease(y,function(){g()})}function g(){console.log("Sleeping for 1 second...");global.clearTimeout(e);e=global.setTimeout(a,1000)}if(n){s()}else{console.error("Repository must be setup before running update components")}};a()};